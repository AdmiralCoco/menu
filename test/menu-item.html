<!doctype html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>d2l-menu-item tests</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
		<script src="../../webcomponentsjs/webcomponents-lite.js"></script>
		<script src="../../web-component-tester/browser.js"></script>
		<link rel="import" href="../../iron-test-helpers/iron-test-helpers.html">
		<link rel="import" href="../d2l-menu.html">
		<link rel="import" href="../d2l-menu-item.html">
		<link rel="import" href="../d2l-menu-item-checkbox.html">
		<link rel="import" href="../d2l-menu-item-radio.html">
	</head>
	<body>

		<test-fixture id="menu">
			<template>
				<d2l-menu id="menu">
					<d2l-menu-item id="a1"></d2l-menu-item>
					<d2l-menu-item id="b1">
						<d2l-menu id="nestedMenu">
							<d2l-menu-item id="a2"></d2l-menu-item>
							<d2l-menu-item id="b2"></d2l-menu-item>
						</d2l-menu>
					</d2l-menu-item>
					<d2l-menu-item id="c1" disabled></d2l-menu-item>
					<d2l-menu-item-checkbox id="check1" value="1"></d2l-menu-item-checkbox>
					<d2l-menu-item-checkbox id="check2" value="2"></d2l-menu-item-checkbox>
					<d2l-menu-item-checkbox id="check3" value="3" disabled></d2l-menu-item-checkbox>
					<d2l-menu-item-radio id="radio1" value="1"></d2l-menu-item-radio>
					<d2l-menu-item-radio id="radio2" value="2"></d2l-menu-item-radio>
					<d2l-menu-item-radio id="radio3" value="3" disabled></d2l-menu-item-radio>
				</d2l-menu>
			</template>
		</test-fixture>

		<script>

		describe('<d2l-menu-item>', function() {

			var menu;

			beforeEach(function() {
				menu = fixture('menu');
			});

			it('has role="menuitem"', function() {
				expect(menu.querySelector('#a1').getAttribute('role')).to.equal('menuitem');
			});

			it('has aria-haspopup="true" when item contains nested menu', function() {
				expect(menu.querySelector('#b1').getAttribute('aria-haspopup')).to.equal('true');
			});

			it('fires select event when item is clicked', function(done) {
				menu.addEventListener('select', function(e) {
					expect(e.target.id).to.equal('a1');
					done();
				});
				menu.querySelector('#a1').click();
			});

			it('fires select event when enter key pressed on item', function(done) {
				menu.addEventListener('select', function(e) {
					expect(e.target.id).to.equal('a1');
					done();
				});
				MockInteractions.keyDownOn(menu.querySelector('#a1'), 13);
			});

			it('fires select event when space key pressed on item', function(done) {
				menu.addEventListener('select', function(e) {
					expect(e.target.id).to.equal('a1');
					done();
				});
				MockInteractions.keyDownOn(menu.querySelector('#a1'), 32);
			});

			it('does not fire select event for disabled item', function(done) {
				var fired = false;
				menu.addEventListener('select', function(e) {
					fired = true;
				});
				setTimeout(function() {
					expect(fired).to.be.false;
					done();
				}, 0);
				MockInteractions.keyDownOn(menu.querySelector('#c1'), 13);
			});

		});

		describe('<d2l-menu-item-checkbox>', function () {

			var menu,
				checkbox;

			beforeEach(function () {
				menu = fixture('menu');
				checkbox = menu.querySelector('#check1');
			});

			it('has role="menuitemcheckbox"', function () {
				expect(checkbox.getAttribute('role')).to.equal('menuitemcheckbox');
			});

			it('swallows the "select" event', function (done) {
				var fired = false;
				menu.addEventListener('select', function(e) {
					fired = true;
				});
				setTimeout(function() {
					expect(fired).to.be.false;
					done();
				}, 0);
				checkbox.click();
			});

			it('fires d2l-menu-item-change event when item is clicked', function (done) {
				checkbox.addEventListener('d2l-menu-item-change', function(e) {
					expect(e.detail.value).to.equal('1');
					expect(e.detail.selected).to.be.true;
					done();
				});
				checkbox.click();
			});

			it('fires d2l-menu-item-change event when enter key pressed on item', function(done) {
				checkbox.addEventListener('d2l-menu-item-change', function(e) {
					done();
				});
				MockInteractions.keyDownOn(checkbox, 13);
			});

			it('fires d2l-menu-item-change event when space key pressed on item', function(done) {
				checkbox.addEventListener('d2l-menu-item-change', function(e) {
					done();
				});
				MockInteractions.keyDownOn(checkbox, 32);
			});

			it('does not fire d2l-menu-item-change event for disabled item', function(done) {
				checkbox = menu.querySelector('#check3');
				var fired = false;
				checkbox.addEventListener('d2l-menu-item-change', function(e) {
					fired = true;
				});
				setTimeout(function() {
					expect(fired).to.be.false;
					done();
				}, 0);
				MockInteractions.keyDownOn(checkbox, 13);
			});

			it('should toggle state on selection', function (done) {
				var expected = true;
				checkbox.addEventListener('d2l-menu-item-change', function(e) {
					expect(checkbox.selected).to.equal(expected);
					expect(e.detail.selected).to.equal(expected);
					expect(e.detail.value).to.equal('1');
					if (!expected) {
						done();
					}
					expected = false;
				});
				checkbox.click();
				checkbox.click();
			});

			it('does not affect other checkboxes in the menu when selected', function (done) {
				checkbox.addEventListener('d2l-menu-item-change', function(e) {
					expect(checkbox.selected).to.be.true;
					expect(menu.querySelector('#check2').selected).to.be.false;
					done();
				});
				checkbox.click();
			});

		});

		describe('<d2l-menu-item-radio>', function () {

			var menu,
				radio;

			beforeEach(function () {
				menu = fixture('menu');
				radio = menu.querySelector('#radio1');
			});

			it('has role="menuitemradio"', function () {
				expect(radio.getAttribute('role')).to.equal('menuitemradio');
			});

			it('swallows the "select" event', function (done) {
				var fired = false;
				menu.addEventListener('select', function(e) {
					fired = true;
				});
				setTimeout(function() {
					expect(fired).to.be.false;
					done();
				}, 0);
				radio.click();
			});

			it('fires d2l-menu-item-change event when item is clicked', function (done) {
				radio.addEventListener('d2l-menu-item-change', function(e) {
					expect(e.detail.value).to.equal('1');
					expect(e.detail.selected).to.be.true;
					done();
				});
				radio.click();
			});

			it('fires d2l-menu-item-change event when enter key pressed on item', function(done) {
				radio.addEventListener('d2l-menu-item-change', function(e) {
					done();
				});
				MockInteractions.keyDownOn(radio, 13);
			});

			it('fires d2l-menu-item-change event when space key pressed on item', function(done) {
				radio.addEventListener('d2l-menu-item-change', function(e) {
					done();
				});
				MockInteractions.keyDownOn(radio, 32);
			});

			it('does not fire d2l-menu-item-change event for disabled item', function(done) {
				radio = menu.querySelector('#radio3');
				var fired = false;
				radio.addEventListener('d2l-menu-item-change', function(e) {
					fired = true;
				});
				setTimeout(function() {
					expect(fired).to.be.false;
					done();
				}, 0);
				MockInteractions.keyDownOn(radio, 13);
			});

			it('should set selected=true on selection', function (done) {
				var clicks = 0;
				radio.addEventListener('d2l-menu-item-change', function(e) {
					expect(radio.selected).to.be.true;
					expect(e.detail.selected).to.be.true;
					expect(e.detail.value).to.equal('1');
					if (clicks > 0) {
						done();
					}
					clicks++;
				});
				radio.click();
				radio.click();
			});

			it('deselects other radio options in the menu when selected', function (done) {
				menu.querySelector('#radio2').click();

				radio.addEventListener('d2l-menu-item-change', function(e) {
					expect(radio.selected).to.be.true;
					expect(menu.querySelector('#radio2').selected).to.be.false;
					done();
				});
				radio.click();
			});

		});
		</script>
	</body>
</html>
